<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<!--  <link rel="stylesheet" href="../static/css/bootstrap.css">-->
  <link href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdn.staticfile.org/echarts/4.3.0/echarts.min.js"></script>
  <script src="../static/js/jquery-3.3.1.js"></script>
  <script src="../static/js/bootstrap.js"></script>
  <title>query spectrum</title>
  <style>
    body{
      background-color: #e0e0e0;
    }
    .page-header{
      margin-top: 15px;
      /*background-color: #337ab7;*/
    }
    .glyphicon-search{
      font-size: 40px;

    }
    p{
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      font-size: 20px;
    }
    span{
      font-size: 50px;
    }
    span.sp{
      display: inline;
      font-size: 20px;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    }
    /*input{*/
    /*  margin-left: 10px;*/

    /*}*/
    .btn{
      margin-bottom: 10px;
    }


  </style>
</head>
<body>

<div class="container">
  <div class="page-header">
    <span>光谱信息查询 </span> <span class="glyphicon glyphicon-search"></span>
  </div>

  <!--  query spectrum-->

<!--    <input type="text" placeholder="name\id\cas">-->
<!--    <button type="submit" class="btn btn-primary" id="retrieve-btn">-->
<!--      提交-->
<!--    </button>-->
  <div class="row">
    <div class="col-md-6">
<!--      <span class="sp"><b>请输入光谱名字\光谱id\CAS编号:</b></span>-->
<!--      <div class="input-group">-->
<!--        <input type="text" class="form-control" placeholder="Please enter spectrum name \  spectrum ID  \ CAS number">-->
<!--        <span class="input-group-btn">-->
<!--        <button class="btn btn-default" type="button">Go!</button><br>-->
<!--      </span>-->
<!--      </div>&lt;!&ndash; /input-group &ndash;&gt;-->
      <p><b>请选择查询方式：</b></p>
      <div class="query_data">
        <form name='query' method="post" action="/spectrum/query">
          <!--                <input type="text" name = "query_sort" placeholder="id/CAS/name">-->
          <input type="radio" name="query_sort" value="id" placeholder="id">id <br>
          <input type="radio" name="query_sort" value="CAS" placeholder="cas">cas
          <br>
          <input type="radio" name="query_sort" value="name" placeholder="name">name
          <br>
          <input type="text" style=" width: 300px" name="query_number" placeholder="Please enter spectrum id\ Name \ CAS number">
          <input type="submit" value="query_submit">
        </form>

      </div>
    </div><!-- /.col-lg-6 -->
    <div class="col-md-6">
      <input type="file" class="btn btn-primary" id="file-loader" multiple>
      <!--添加一个文本框用来输入光谱号，根据光谱编号进行更新-->
      <input type="text" value="" id="spectrum_id" placeholder="Please enter spectrum id"/>
      <button type="submit" class="btn btn-danger" id="update-btn">
        update
      </button>
      <button type="submit" class="btn btn-danger" id="delete-btn">
        delete
      </button>


    </div>
    <div class="col-md-12">
      <p><b>查询信息如下:</b></p>
    </div>
  </div><!-- /.row -->



  <div class="graph">
    <div id="echarts" style="height: 400px; width: 400px;"></div>
  </div>
</div>

<script>
  var spectrums = [];
  var fileLoader = document.getElementById("file-loader");
  fileLoader.addEventListener("change", (event) => {
    const files = event.target.files;
    for (var i = 0, f; f = files[i]; i++) {
      var reader = new FileReader();
      reader.onload = (function (theFile) {
        return function (e) {
          var span = document.createElement('span');
          let spectrum = e.target.result
          // span.innerHTML = ['<img class="thumb" src="', e.target.result,
          //                 '" title="', escape(theFile.name), '"/>'].join('');
          spectrum = loadSpectrum(spectrum)
          spectrums.push(spectrum)
          console.log(spectrum);
          const option = {
            title: {
              text: spectrums[0].name+'的原始拉曼光谱图像为'
            },
            tooltip: {},
            legend: {
            },
            xAxis: {
              // type:'value',

              data: spectrums[0].data.x
            },
            yAxis: {
              data: spectrums[0].data.y

            },
            series: [{
              // name: 'asd',
              // type: 'bar',
              type: 'line',
              data: spectrums[0].data.y
            }]
          }
          drawChart(option)
        };
      })(f);
      reader.readAsText(f);
    }

  })

  // <!--update点击事件-->
  var update = document.getElementById('update-btn');
  update.addEventListener('click', e => {
    var oinput = document.getElementById('spectrum_id');
    var spectrum_id = oinput.value;
    for (let spectrum of spectrums) {
      console.log(spectrum);
      if (window.confirm("update spectrum " + spectrum_id + "?")) {
        axios.put('/spectrum/' + spectrum_id, spectrum);
        return true;
      } else {
        return false;
      }
    }
  });

  <!--delete点击事件-->
  var delete_b = document.getElementById('delete-btn');
  delete_b.addEventListener('click', e => {
    var oinput = document.getElementById('spectrum_id');
    var spectrum_id = oinput.value;
    if (window.confirm("delete spectrum " + spectrum_id + "?")) {
      axios.delete('/spectrum/' + spectrum_id);
      return true;
    } else {
      return false;
    }
  });

  function loadSpectrum(spectrum) {
    const lines = spectrum.split('\n');
    const res = {};
    const x = [], y = [];
    for (let line of lines) {
      if (line.includes('#')) {
        // strip #
        line = line.replace(/#/g, '');

        // key value
        for (let sep of [':', '=']) {
          if (line.includes(sep)) {
            let prop = line.split(sep);
            if (prop.length !== 2) continue;
            if (!prop[0] || !prop[1]) continue;
            let key = prop[0].trim().replace(' ', '_').toLowerCase();
            let val = prop[1].trim();
            if (key.includes('name')) key = 'name';
            // if(key in ['name', 'cas', 'description', 'measured_chemistry', 'ideal_chemistry', 'orientation', 'status', 'pin_id', 'source','locality'])
            res[key] = val;
            break;
          }
        }
      } else {
        let isDigit = x => /^\d+$/g.test(x.trim());

        for (let sep of [' ', ',']) {
          let xy = line.split(sep);
          if (xy.length !== 2) continue;
          if (isDigit(xy[0]) || isDigit(xy[1])) continue;
          x.push(+xy[0].trim());
          y.push(+xy[1].trim())
        }
        res.data = {x, y}
      }


    }
    return res
  }

  // graph
  var myChart = echarts.init(document.getElementById('echarts'));

  // var
  // myChart.setOption(option);
  function drawChart(option) {
    myChart.setOption(option);
  }
  //query
  function reinitIframe() {
    var iframe = document.getElementById("urlIframe");
    try {
      var bHeight = iframe.contentWindow.document.body.scrollHeight;
      iframe.height = bHeight;
    } catch (ex) {
    }
  }
</script>

</body>
</html>
