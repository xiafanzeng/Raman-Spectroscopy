<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<!--  <link rel="stylesheet" href="../static//css/bootstrap.css">-->
  <link href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdn.staticfile.org/echarts/4.3.0/echarts.min.js"></script>
  <script src="../static/js/jquery-3.3.1.js"></script>
  <script src="../static/js/bootstrap.js"></script>
<!--  <script src="../static/fonts/glyphicons-halflings-regular.svg"></script>-->
    <title>create spectrum</title>
  <style type="text/css">
    body{
      background-color: #e0e0e0;
    }
    .page-header{
      margin-top: 15px;
      /*background-color: #337ab7;*/
    }
    .createsp {
      /*margin-left: 100px;*/
      /*background-color: #337ab7;*/
      font-size: 50px;
    }

    .glyphicon-edit{
      font-size: 40px;
    }
    p{
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      font-size: 20px;
    }
    span{
      font-size: 50px;
    }
    span.sp{
      display: inline;
      font-size: 20px;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    }
    /*input{*/
    /*  margin-left: 10px;*/

    /*}*/
    .btn{
      margin-bottom: 10px;
    }
    #retrieve-btn span{

      font-size: 12px;
      line-height: 100%;
    }

  </style>
</head>
<body>
<div class="container">
  <div class="page-header ">
    <span class="createsp">创建光谱  <span class="glyphicon glyphicon-edit"></span> </span>

  </div>

  <!-- Flash Message -->

  <div class="row">
    <div class="col-md-12">
      <span class="sp"><b>选择要创建的拉曼光谱数据:</b></span>
    </div>
    <div class="col-md-12">
      <input type="file" class="btn btn-primary" id="file-loader"  multiple>
    </div>
    <div class="col-md-12">
      <button type="submit" class="btn btn-primary" id="retrieve-btn">
        将以上所选文件创建为新的光谱  <span class="glyphicon glyphicon-plus"></span>
      </button>
    </div>
    <div class="col-md-12">
      <p><b>该数据对应光谱图像如下图所示:</b></p>
    </div>
    <div class="graph col-md-12"><b>graph:</b>
      <div id="echarts" style="height: 400px; width: 400px;"></div>
    </div>
  </div>
</div>


<script>
  var spectrums = [];
  var fileLoader = document.getElementById("file-loader");
  fileLoader.addEventListener("change", (event) => {
    const files = event.target.files;
    for (var i = 0, f; f = files[i]; i++) {
      var reader = new FileReader();
      reader.onload = (function (theFile) {
        return function (e) {
          var span = document.createElement('span');
          let spectrum = e.target.result
          // span.innerHTML = ['<img class="thumb" src="', e.target.result,
          //                 '" title="', escape(theFile.name), '"/>'].join('');
          spectrum = loadSpectrum(spectrum)
          spectrums.push(spectrum)
          console.log(spectrum);
          const option = {
            title: {
              text: spectrums[0].name+'的原始拉曼光谱图像为'
            },
            tooltip: {},
            legend: {
            },
            xAxis: {


              name:'拉曼偏移(Raman shift)',
              nameLocation:'center',

              nameTextStyle:{
                padding:[20,0,0,0],
                //    nameGap:10,
                axisLabel:{interval: 500},
                fontSize: 16,
                //
              },

              data: spectrums[0].data.x
            },
            grid: { //图的上下左右边距
              x: 100,
              y: 100,
              x2: "10%",
              y2: 100,
              borderWidth: 10
            },

            yAxis: {
              name:'拉曼强度(Intensity)',
              //坐标轴名称与轴线之间的距离
              nameGap:80,
              //大体位置调整nameLocation,end、start、 center
              nameLocation:'center',
              //nameRotate,旋转度数
              nameRotate:'90',
              nameTextStyle:{
                padding:[0,0,0,0],
                fontSize: 14,

              },
              // axisLabel: {
              //   formatter:function (value, index) {
              //     return value.toFixed(1);
              //   }
              // },
              // type:'value',  //Y轴刻度显示整数
              // min:0,
              // max:22000,
              // interval:2000,
              data: spectrums[0].data.y,


            },
            series: [{
              // name: 'asd',
              // type: 'bar',
              type: 'line',
              data: spectrums[0].data.y
            }]
          }
          drawChart(option)
        };
      })(f);
      reader.readAsText(f);
    }

  })


  var create = document.getElementById('retrieve-btn')
  create.addEventListener('click', e => {
    for(let spectrum of spectrums){
      console.log(spectrum);
      // spectrum.cas='123'
      if(window.confirm( "确定创建该光谱"+"?")){
        axios.post('/spectrum', spectrum)
        return true;
      }
      else{
        return false;
      }
    }
  });


  function loadSpectrum(spectrum) {
    const lines = spectrum.split('\n')
    const res = {}
    const x = [], y = []
    for (let line of lines) {
      if (line.includes('#')) {
        // strip #
        line = line.replace(/#/g, '')

        // key value
        for (let sep of [':', '=']) {
          if (line.includes(sep)) {
            let prop = line.split(sep)
            if (prop.length != 2) continue
            if (!prop[0] || !prop[1]) continue
            let key = prop[0].trim().replace(' ', '_').toLowerCase()
            let val = prop[1].trim()
            if(key.includes('name')) key = 'name'
            // if(key in ['name', 'cas', 'description', 'measured_chemistry', 'ideal_chemistry', 'orientation', 'status', 'pin_id', 'source','locality'])
            res[key] = val
            break;
          }
        }
      }

      else {
        let isDigit = x => /^\d+$/g.test(x.trim())

        for (let sep of [' ', ',']) {
          let xy = line.split(sep)
          if (xy.length != 2) continue
          if (isDigit(xy[0]) || isDigit(xy[1])) continue
          x.push(+xy[0].trim())
          y.push(+xy[1].trim())
        }
        res.data = { x, y }
      }


    }
    return res
  }

  // graph
  var myChart = echarts.init(document.getElementById('echarts'));

  // var
  // myChart.setOption(option);
  function drawChart(option) {
    myChart.setOption(option);
  }
</script>

</body>
</html>
