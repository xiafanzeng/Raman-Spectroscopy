<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<!--  <link rel="stylesheet" href="../static//css/bootstrap.css">-->
  <link href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdn.staticfile.org/echarts/4.3.0/echarts.min.js"></script>
  <script src="../static/js/jquery-3.3.1.js"></script>
  <script src="../static/js/bootstrap.js"></script>
<!--  <script src="../static/fonts/glyphicons-halflings-regular.svg"></script>-->
    <title>create spectrum</title>
  <style type="text/css">
     body{
      font-family: "Microsoft YaHei", Arial, sans-serif;
    }
    .page-header{
      margin-bottom: 10px;

    }
    h1 {
       padding-left: 10px;
       color: #b6bb99;

        font-size: 46px;

}
     h1 span{
       color: #0868a3;
     }
     h1 small{
       color: #747474;
     }
    .clearfix::after,.clearfix::before{
      content: '';
      display: table;
      clear: both;
    }
    .navbar-nav li a{
      margin: auto 50px;
      font-size: 16px;
    }
    .navbar-default .navbar-nav>li>a {
    color: #fff;
}
    .navbar-nav li:hover{
      background-color: darkgray;
    }
    .navbar-default{
      background-color: #337ab7;
    }

    .glyphicon-edit{
      font-size: 23px;
    }
    p{
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      font-size: 20px;
    }
    /*span{*/
      /*font-size: 50px;*/
    /*}*/
    span.sp{
      display: inline;
      font-size: 20px;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      float: left;
    }

    .btn{
      margin: -5px 10px;
      float: left;

    }
    #retrieve-btn span{

      font-size: 12px;
      line-height: 100%;
      float: left;
    }
    #retrieve-btn{
      display: block;
      margin-left: -100px;
    }
    .graph{
      margin: 30px 50px;
    }

  </style>
</head>
<body>
<!--页面头部-->
<div class="page-header">
  <h1><span >Sit</span>Raman System <small>上海应用技术大学拉曼光谱分析系统</small></h1>
</div>
<!--导航栏-->
<nav class="navbar navbar-default">
  <div class="container-fluid first div">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/" style=" color: white;margin-left: 30px">首页</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li class="meta"><a  href="../static/create.html" >上传光谱数据 </a></li>
        <li class="meta"><a href="../static/query.html" >查询光谱信息</a></li>
        <li class="meta"><a href="../static/query.html" >光谱数据分类</a></li>
        <li class="dropdown meta">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false" >了解更多关于拉曼光谱<span class="caret"></span></a>
          <ul class="dropdown-menu" style="background-color: #337ab7">
            <li ><a href="#">拉曼光谱原理</a></li>
            <li ><a href="#">拉曼光谱应用</a></li>
            <li><a href="#">Something else here</a></li>

          </ul>
        </li>
        <li class="meta"><a href="#" >联系我们</a></li>

      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
<div class="container">

  <!-- Flash Message -->

  <div class="row">
    <div class="col-md-12">

      <span class="sp"><b>选择要上传的拉曼光谱数据
        <span class="glyphicon glyphicon-edit"></span> ：</b>
      </span><input type="file" class="btn " id="file-loader"  multiple>
       <button type="submit" class="btn btn-primary" id="retrieve-btn">
        上传光谱数据
      </button>

    </div>

    <div class="graph col-md-12">
      <div id="echarts" style="height: 500px; width: 500px;"></div>
    </div>
  </div>
</div>


<script>
  var spectrums = [];
  var fileLoader = document.getElementById("file-loader");
  fileLoader.addEventListener("change", (event) => {
    const files = event.target.files;
    for (var i = 0, f; f = files[i]; i++) {
      var reader = new FileReader();
      reader.onload = (function (theFile) {
        return function (e) {
          var span = document.createElement('span');
          let spectrum = e.target.result
          // span.innerHTML = ['<img class="thumb" src="', e.target.result,
          //                 '" title="', escape(theFile.name), '"/>'].join('');
          spectrum = loadSpectrum(spectrum)
          spectrums.push(spectrum)
          console.log(spectrum);
          const option = {
            title: {
              text: spectrums[0].name+'的原始拉曼光谱图像为'
            },
            tooltip: {},
            legend: {
            },
            xAxis: {


              name:'拉曼偏移(Raman shift)',
              nameLocation:'center',

              nameTextStyle:{
                padding:[20,0,0,0],
                //    nameGap:10,
                axisLabel:{interval: 500},
                fontSize: 16,
                //
              },

              data: spectrums[0].data.x
            },
            grid: { //图的上下左右边距
              x: 100,
              y: 100,
              x2: "10%",
              y2: 100,
              borderWidth: 10
            },
             yAxis: {
                name:'拉曼强度(Intensity)',
                //坐标轴名称与轴线之间的距离
                nameGap:80,
                //大体位置调整nameLocation,end、start、 center
                nameLocation:'center',
                //nameRotate,旋转度数
                nameRotate:'90',
                nameTextStyle:{
                  padding:[0,0,0,0],
                  fontSize: 14,

                },
                axisLabel: {
                  formatter:function (value, index) {
                    return value.toFixed(1);
                  }
                },
                type:'value',  //Y轴刻度显示整数
                min:spectrums[0].data.y.min,
                max:spectrums[0].data.y.max,
                // interval:spectrums[0].data.y.length*5,
                data: spectrums[0].data.y,


              },
              series: [{
                // name: 'asd',
                // type: 'bar',
                type: 'line',
                data: spectrums[0].data.y
              }]
            }
            drawChart(option)
          };
        })(f);
        reader.readAsText(f);
      }

    })

  //           yAxis: {
  //             name:'拉曼强度(Intensity)',
  //             //坐标轴名称与轴线之间的距离
  //             nameGap:80,
  //             //大体位置调整nameLocation,end、start、 center
  //             nameLocation:'center',
  //             //nameRotate,旋转度数
  //             nameRotate:'90',
  //             nameTextStyle:{
  //               padding:[0,0,0,0],
  //               fontSize: 14,
  //
  //             },
  //             // axisLabel: {
  //             //   formatter:function (value, index) {
  //             //     return value.toFixed(1);
  //             //   }
  //             // },
  //             // type:'value',  //Y轴刻度显示整数
  //             // min:0,
  //             // max:22000,
  //             // interval:2000,
  //             data: spectrums[0].data.y,
  //
  //
  //           },
  //           series: [{
  //             // name: 'asd',
  //             // type: 'bar',
  //             type: 'line',
  //             data: spectrums[0].data.y
  //           }]
  //         }
  //         drawChart(option)
  //       };
  //     })(f);
  //     reader.readAsText(f);
  //   }
  //
  // })


  var create = document.getElementById('retrieve-btn')
  create.addEventListener('click', e => {
    for(let spectrum of spectrums){
      console.log(spectrum);
      // spectrum.cas='123'
      if(window.confirm( "确定上传该光谱"+"?")){
        axios.post('/spectrum', spectrum)
        return true;
      }
      else{
        return false;
      }
    }
  });


  function loadSpectrum(spectrum) {
    const lines = spectrum.split('\n')
    const res = {}
    const x = [], y = []
    for (let line of lines) {
      if (line.includes('#')) {
        // strip #
        line = line.replace(/#/g, '')

        // key value
        for (let sep of [':', '=']) {
          if (line.includes(sep)) {
            let prop = line.split(sep)
            if (prop.length != 2) continue
            if (!prop[0] || !prop[1]) continue
            let key = prop[0].trim().replace(' ', '_').toLowerCase()
            let val = prop[1].trim()
            if(key.includes('name')) key = 'name'
            // if(key in ['name', 'cas', 'description', 'measured_chemistry', 'ideal_chemistry', 'orientation', 'status', 'pin_id', 'source','locality'])
            res[key] = val
            break;
          }
        }
      }

      else {
        // let isDigit = x => /^\d+$/g.test(x.trim());
        // let isDigit1 = x => /^\d+(\.\d+)?$/g.test(x.trim());

        for (let sep of [' ', ',']) {
          let xy = line.split(sep);
          if (xy.length != 2) continue;
          // if (isDigit(xy[0]) || isDigit(xy[1])) continue;
          x.push(+xy[0].trim());
          y.push(+xy[1].trim())
        }
        res.data = { x, y }
      }


    }
    return res
  }
  // graph
  var myChart = echarts.init(document.getElementById('echarts'));

  // var
  // myChart.setOption(option);
  function drawChart(option) {
    myChart.setOption(option);
  }
</script>

</body>
</html>
