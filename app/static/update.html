<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/bootstrap.css">
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdn.staticfile.org/echarts/4.3.0/echarts.min.js"></script>
  <script src="js/jquery-3.3.1.js"></script>
  <script src="js/bootstrap.js"></script>
    <title>更新光谱</title>
  <style>

  </style>
</head>
<body>
<!--添加一个文本框用来输入光谱号，根据光谱编号进行更新-->
<input type="file" class="btn btn-primary" id="file-loader" multiple>
<!--<input type="text" class="form-control" id="wishlist_id" placeholder="Enter ID of CAS" />-->
<input type="text" value="" id="spectrum_id" placeholder="Please enter spectrum id"/>
<button type="submit" class="btn btn-danger" id="update-btn">
  update
</button>
<script>
  var spectrums = [];
  var fileLoader = document.getElementById("file-loader");
  fileLoader.addEventListener("change", (event) => {
    const files = event.target.files;
    for (var i = 0, f; f = files[i]; i++) {
      var reader = new FileReader();
      reader.onload = (function (theFile) {
        return function (e) {
          var span = document.createElement('span');
          let spectrum = e.target.result
          // span.innerHTML = ['<img class="thumb" src="', e.target.result,
          //                 '" title="', escape(theFile.name), '"/>'].join('');
          spectrum = loadSpectrum(spectrum)
          spectrums.push(spectrum)
          console.log(spectrum);
          const option = {
            title: {
              text: spectrums[0].name
            },
            tooltip: {},
            legend: {
            },
            xAxis: {
              data: spectrums[0].data.x
            },
            yAxis: {
              data: spectrums[0].data.y
            },
            series: [{
              // name: 'asd',
              // type: 'bar',
              type: 'line',
              data: spectrums[0].data.y
            }]
          }
          drawChart(option)
        };
      })(f);
      reader.readAsText(f);
    }

  })

  var create = document.getElementById('retrieve-btn')
  create.addEventListener('click', e => {
    for(let spectrum of spectrums){
      console.log(spectrum);
      // spectrum.cas='123'
      if(window.confirm( "确定创建该光谱"+"?")){
        axios.post('/spectrum', spectrum)
        return true;
      }else{
        return false;
      }
    }
  });


  //update点击事件
  var uptate = document.getElementById('update-btn')
  uptate.addEventListener('click', e => {
    var oinput=document.getElementById('spectrum_id');
    var spectrum_id=oinput.value;
    for(let spectrum of spectrums){
      console.log(spectrum);
      if(window.confirm("update spectrum "+spectrum_id+"?")){
        axios.put('/spectrum/'+spectrum_id, spectrum);
        return true;
      }else{
        return false;
      }
    }
  });



  function loadSpectrum(spectrum) {
    const lines = spectrum.split('\n')
    const res = {}
    const x = [], y = []
    for (let line of lines) {
      if (line.includes('#')) {
        // strip #
        line = line.replace(/#/g, '')

        // key value
        for (let sep of [':', '=']) {
          if (line.includes(sep)) {
            let prop = line.split(sep)
            if (prop.length != 2) continue
            if (!prop[0] || !prop[1]) continue
            let key = prop[0].trim().replace(' ', '_').toLowerCase()
            let val = prop[1].trim()
            if(key.includes('name')) key = 'name'
            // if(key in ['name', 'cas', 'description', 'measured_chemistry', 'ideal_chemistry', 'orientation', 'status', 'pin_id', 'source','locality'])
            res[key] = val
            break;
          }
        }
      }

      else {
        // let isDigit = x => /^\d+$/g.test(x.trim())

        for (let sep of [' ', ',']) {
          let xy = line.split(sep);
          if (xy.length != 2) continue;
          // if (isDigit(xy[0]) || isDigit(xy[1])) continue;
          x.push(+xy[0].trim());
          y.push(+xy[1].trim())
        }
        res.data = { x, y }
      }


    }
    return res
  }

  // graph
  var myChart = echarts.init(document.getElementById('echarts'));

  // var
  // myChart.setOption(option);
  function drawChart(option) {
    myChart.setOption(option);
  }
</script>

</body>
</html>
